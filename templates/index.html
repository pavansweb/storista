<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================= SUPABASE CONFIG ================= */
const SUPABASE_URL = "https://imqycjjsclifhjotdvpf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltcXljampzY2xpZmhqb3RkdnBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjM0NDksImV4cCI6MjA4NzYzOTQ0OX0.Ummz44dHUR914GsmoEuBlNeuJqfGZvnNfgGmpkLdttg"; // NOT service role key

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= EXISTING VARIABLES ================= */
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const selectedFile = document.getElementById('selectedFile');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');
const uploadForm = document.getElementById('uploadForm');
const uploadOverlay = document.getElementById('upload-overlay');
const urlInput = document.getElementById('urlInput');

/* ================= DRAG + DROP ================= */
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
  });
});

dropZone.addEventListener('drop', e => {
  fileInput.files = e.dataTransfer.files;
  updateFileName();
});

fileInput.addEventListener('change', updateFileName);

function updateFileName() {
  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    fileName.value = file.name;
    fileSize.textContent = formatFileSize(file.size);
    selectedFile.classList.add('show');
  }
}

function removeFile() {
  fileInput.value = '';
  fileName.value = '';
  fileSize.textContent = '';
  selectedFile.classList.remove('show');
}

function formatFileSize(bytes) {
  if (!bytes) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

/* ================= DIRECT UPLOAD TO SUPABASE ================= */
uploadForm.addEventListener('submit', async function(e) {
  e.preventDefault();

  const file = fileInput.files[0];
  const hasFile = !!file;
  const hasUrl = urlInput.value.trim() !== '';

  if (!hasFile && !hasUrl) {
    showNotification('Please select a file or enter a URL', 'warning');
    return;
  }

  uploadOverlay.classList.add('show');

  try {
    const folder = "{{ current_folder or '' }}";

    /* ---- FILE UPLOAD ---- */
    if (hasFile) {
      const customName = fileName.value.trim() || file.name;
      const path = folder 
        ? `storage/${folder}/${customName}`
        : `storage/${customName}`;

      const { error } = await sb
        .storage
        .from("storage")
        .upload(path, file, { upsert: true });

      if (error) throw error;
    }

    /* ---- URL UPLOAD ---- */
    if (hasUrl) {
      const response = await fetch(urlInput.value);
      if (!response.ok) throw new Error("Failed to fetch URL");

      const blob = await response.blob();
      const fileNameFromUrl = urlInput.value.split('/').pop().split('?')[0];

      const path = folder
        ? `storage/${folder}/${fileNameFromUrl}`
        : `storage/${fileNameFromUrl}`;

      const { error } = await sb
        .storage
        .from("storage")
        .upload(path, blob, { upsert: true });

      if (error) throw error;
    }

    showNotification('✅ Upload successful!', 'success');
    setTimeout(() => location.reload(), 1000);

  } catch (err) {
    showNotification('❌ Upload failed: ' + err.message, 'danger');
    uploadOverlay.classList.remove('show');
  }
});

/* ================= NOTIFICATIONS ================= */
function showNotification(message, type) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} message-alert`;
  alertDiv.innerHTML =
    `<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}" style="font-size: 1.5rem;"></i>
     <span>${message}</span>`;

  const container = document.querySelector('.cloud-card .p-3');
  container.insertBefore(alertDiv, container.firstChild);

  setTimeout(() => alertDiv.remove(), 5000);
}
</script>
